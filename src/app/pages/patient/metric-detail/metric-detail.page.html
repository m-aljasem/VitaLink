<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/tabs/home"></ion-back-button>
    </ion-buttons>
    <ion-title>{{ 'METRICS.' + metric.toUpperCase() | translate }}</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding">
  <div class="metric-detail-container">
    <!-- Entry Form -->
    <div class="entry-form" *ngIf="showForm">
      <h2>{{ 'METRICS.ENTER_VALUE' | translate }}</h2>

      <div *ngIf="metric === 'bp'">
        <ion-item>
          <ion-label position="stacked">{{ 'ONBOARDING.SYSTOLIC' | translate }}</ion-label>
          <ion-input type="number" [(ngModel)]="systolic"></ion-input>
        </ion-item>
        <ion-item>
          <ion-label position="stacked">{{ 'ONBOARDING.DIASTOLIC' | translate }}</ion-label>
          <ion-input type="number" [(ngModel)]="diastolic"></ion-input>
        </ion-item>
        <ion-item>
          <ion-label position="stacked">{{ 'METRICS.PULSE' | translate }} ({{ 'COMMON.OPTIONAL' | translate }})</ion-label>
          <ion-input type="number" [(ngModel)]="pulse" placeholder="bpm"></ion-input>
        </ion-item>
      </div>

      <div *ngIf="metric !== 'bp'">
        <ion-item>
          <ion-label position="stacked">{{ 'METRICS.ENTER_VALUE' | translate }}</ion-label>
          <ion-input type="number" [(ngModel)]="numericValue"></ion-input>
        </ion-item>
      </div>

      <div class="date-time-section">
        <ion-label class="date-label">{{ 'METRICS.DATE_TIME' | translate }}</ion-label>
        <div class="date-buttons">
          <ion-button 
            expand="block" 
            [fill]="dateSelectionMode === 'right-now' ? 'solid' : 'outline'"
            [color]="dateSelectionMode === 'right-now' ? 'primary' : 'medium'"
            (click)="setRightNow()" 
            class="date-button">
            {{ 'METRICS.RIGHT_NOW' | translate }}
          </ion-button>
          <ion-button 
            expand="block" 
            [fill]="dateSelectionMode === 'custom' ? 'solid' : 'outline'"
            [color]="dateSelectionMode === 'custom' ? 'primary' : 'medium'"
            (click)="openDatePicker()" 
            class="date-button">
            {{ 'METRICS.CHOOSE_DATE' | translate }}
          </ion-button>
        </div>
        <ion-text class="selected-date-text" color="medium">
          {{ formatDateTime(selectedDateTime) }}
        </ion-text>
      </div>

      <div *ngIf="availableTags.length > 0" class="tags-section">
        <p>{{ 'METRICS.TAGS' | translate }}</p>
        <div class="tags-container">
          <ion-chip
            *ngFor="let tag of availableTags"
            [color]="selectedTags.includes(tag) ? 'primary' : 'medium'"
            (click)="toggleTag(tag)"
          >
            {{ tag | translate }}
          </ion-chip>
        </div>
      </div>

      <ion-button expand="block" (click)="save()" class="ion-margin-top save-button">
        {{ 'COMMON.SAVE' | translate }}
      </ion-button>
    </div>

    <!-- Add New Record Button (shown when form is hidden) -->
    <div *ngIf="!showForm" class="add-record-section">
      <ion-button expand="block" (click)="showAddForm()" class="add-record-button">
        {{ 'METRICS.ADD_NEW_RECORD' | translate }}
      </ion-button>
    </div>

    <!-- Chart -->
    <div class="chart-section" *ngIf="chartData.length > 0">
      <h2>{{ 'METRICS.CHART' | translate }}</h2>
      <app-line-chart [data]="chartData" [labels]="chartLabels" [color]="chartColor"></app-line-chart>
    </div>

    <!-- History -->
    <div class="history-section">
      <h2>{{ 'METRICS.HISTORY' | translate }}</h2>
      <div class="history-cards">
        <ion-card *ngFor="let obs of observations" class="history-card" [style.border-left-color]="chartColor">
          <ion-card-content>
            <div class="history-card-header">
              <ion-icon [name]="getMetricIcon(obs.metric)" [style.color]="chartColor" class="history-icon"></ion-icon>
              <div class="history-value-wrapper">
                <div class="history-value" [style.color]="chartColor">
                  {{ formatValue(obs) }}
                </div>
                <div *ngIf="obs.tags && obs.tags.length > 0" class="history-tags">
                  <ion-chip *ngFor="let tag of obs.tags" size="small" color="primary">
                    {{ tag | translate }}
                  </ion-chip>
                </div>
              </div>
            </div>
            <div class="history-card-footer">
              <ion-text class="history-time">
                <ion-icon name="time-outline" size="small"></ion-icon>
                {{ formatTime(obs.ts) }}
              </ion-text>
            </div>
          </ion-card-content>
        </ion-card>
      </div>
    </div>
  </div>
</ion-content>

