import{a as u}from"./chunk-FEUMV7UB.js";import{f as p}from"./chunk-IPUYINSA.js";import{g as a}from"./chunk-2R6CW7ES.js";var _=(()=>{let s=class s{constructor(){this.supabase=u()}createToken(r){return a(this,null,function*(){let e=Math.floor(1e5+Math.random()*9e5).toString(),t=new Date;t.setMinutes(t.getMinutes()+15);let{data:i,error:o}=yield this.supabase.from("link_tokens").insert({provider_id:r,code:e,expires_at:t.toISOString(),used:!1}).select().single();return{data:i,error:o}})}redeemToken(r,e){return a(this,null,function*(){let{data:t,error:i}=yield this.supabase.from("link_tokens").select("*").eq("code",r).eq("used",!1).gt("expires_at",new Date().toISOString()).single();if(i||!t)return{error:i||new Error("Invalid or expired code")};let{data:o}=yield this.supabase.from("provider_links").select("*").eq("provider_id",t.provider_id).eq("patient_id",e).single(),l;if(o){let{data:c,error:n}=yield this.supabase.from("provider_links").update({}).eq("id",o.id).select().single();if(l=c,n)return{error:n}}else{let{data:c,error:n}=yield this.supabase.from("provider_links").insert({provider_id:t.provider_id,patient_id:e,share_bp:!1,share_glucose:!1,share_spo2:!1,share_hr:!1,share_pain:!1,share_weight:!1}).select().single();if(l=c,n)return{error:n}}return yield this.supabase.from("link_tokens").update({used:!0}).eq("id",t.id),{data:l}})}getProviderLinks(r){return a(this,null,function*(){let{data:e,error:t}=yield this.supabase.from("provider_links").select("*").eq("provider_id",r);return{data:e,error:t}})}getPatientLinks(r){return a(this,null,function*(){let{data:e,error:t}=yield this.supabase.from("provider_links").select("*").eq("patient_id",r);return{data:e,error:t}})}updateSharing(r,e){return a(this,null,function*(){let{data:t,error:i}=yield this.supabase.from("provider_links").update(e).eq("id",r).select().single();return{data:t,error:i}})}revokeLink(r){return a(this,null,function*(){let{error:e}=yield this.supabase.from("provider_links").delete().eq("id",r);return{error:e}})}getActiveTokens(r){return a(this,null,function*(){let{data:e,error:t}=yield this.supabase.from("link_tokens").select("*").eq("provider_id",r).eq("used",!1).gt("expires_at",new Date().toISOString()).order("created_at",{ascending:!1});return{data:e,error:t}})}};s.\u0275fac=function(e){return new(e||s)},s.\u0275prov=p({token:s,factory:s.\u0275fac,providedIn:"root"});let d=s;return d})();export{_ as a};
